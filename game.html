<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cattura i Regali di Natale (Stabilit√† Massima)</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
        }
        #game-container {
            width: 500px;
            height: 400px;
            border: 5px solid #0056b3;
            background-color: #e0ffff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        .falling-object {
            position: absolute;
            font-size: 45px;
            text-align: center;
            user-select: none;
        }
        #sleigh {
            position: absolute;
            bottom: 0;
            width: 80px; 
            height: 50px;
            text-align: center;
            font-size: 55px; 
            cursor: move;
            user-select: none;
        }
        #score-panel { 
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 2px solid #0056b3;
            width: 500px;
            text-align: center;
            
            display: flex; 
            justify-content: space-around;
            align-items: center;
        }
        #level-display {
            font-weight: bold;
            color: #d9534f;
        }
    </style>
</head>
<body>

    <h2>üéÑ Cattura i Regali in Caduta üéÖ</h2>
    <p>Usa il mouse per trascinare Babbo Natale o le frecce della tastiera (‚Üê e ‚Üí).</p>

    <div id="score-panel">
        <div>Livello: <span id="level-display">1</span></div>
        <div>Punteggio: <span id="score">0</span></div>
        <div>Mancati: <span id="missed">0</span></div>
        <button id="restart-button">Riavvia il Gioco</button>
    </div>

    <div id="game-container">
        <div id="sleigh">üéÖ</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =========================================================
            // üîë VARIABILI DIDATTICHE E MODIFICABILI
            // =========================================================

            let GRAVITY_FACTOR = 1.2; 
            let SPAWN_INTERVAL_MS = 1000; 
            const SLEIGH_WIDTH = 80;    
            const OBJECT_SIZE = 45;     
            const SLEIGH_SPEED = 10; 
            const COLLISION_BUFFER_Y = 20; 

            // VARIABILI PER IL SISTEMA A LIVELLI
            let currentLevel = 1;
            const INITIAL_GRAVITY = 1.2; 
            const SCORE_TO_NEXT_LEVEL = 150; 
            const LEVEL_INCREASE_GRAVITY = 0.2; 
            const LEVEL_DECREASE_SPAWN = 50; 

            // =========================================================
            // LOGICA DI BASE
            // =========================================================

            const container = document.getElementById('game-container');
            const sleigh = document.getElementById('sleigh');
            const scoreDisplay = document.getElementById('score');
            const missedDisplay = document.getElementById('missed');
            const levelDisplay = document.getElementById('level-display');
            const restartButton = document.getElementById('restart-button'); 

            let score = 0;
            let missed = 0;
            let gameLoopInterval;
            let spawnInterval;
            let running = false;
            
            let objects = []; // üö© Modificato da const a let per maggior flessibilit√† se necessario
            let sleighX;

            function initSleighPosition() {
                sleighX = container.clientWidth / 2 - SLEIGH_WIDTH / 2;
                sleigh.style.left = sleighX + 'px';
            }
            initSleighPosition();

            function updateSleighPosition(newX) {
                if (newX < 0) {
                    newX = 0;
                } else if (newX > container.clientWidth - SLEIGH_WIDTH) {
                    newX = container.clientWidth - SLEIGH_WIDTH;
                }
                sleighX = newX;
                sleigh.style.left = sleighX + 'px';
            }

            // =========================================================
            // SISTEMA A LIVELLI
            // =========================================================

            function levelUp() {
                currentLevel++;

                GRAVITY_FACTOR += LEVEL_INCREASE_GRAVITY;
                SPAWN_INTERVAL_MS = Math.max(400, SPAWN_INTERVAL_MS - LEVEL_DECREASE_SPAWN);
                
                levelDisplay.textContent = currentLevel;

                clearInterval(spawnInterval);
                spawnInterval = setInterval(createFallingObject, SPAWN_INTERVAL_MS);

                alert(`Livello ${currentLevel} raggiunto!\nGravit√† attuale: ${GRAVITY_FACTOR.toFixed(2)}`);
            }

            // =========================================================
            // LOGICA DI GIOCO (updateGame e collisioni)
            // =========================================================

            function createFallingObject() {
                if (!running) return;
                const isGift = Math.random() > 0.3; 
                const type = isGift ? 'gift' : 'coal';
                const emoji = isGift ? 'üéÅ' : '‚ö´';
                
                const obj = document.createElement('div');
                obj.className = 'falling-object';
                obj.textContent = emoji;
                obj.dataset.type = type;

                const posX = Math.random() * (container.clientWidth - OBJECT_SIZE);
                obj.style.left = posX + 'px';
                obj.style.top = '0px';

                container.appendChild(obj);
                objects.push({ element: obj, y: 0, speed: Math.random() * 0.5 + 1.0 });
            }

            function updateGame() {
                if (!running) return;

                if (score >= currentLevel * SCORE_TO_NEXT_LEVEL) {
                    levelUp();
                }

                for (let i = objects.length - 1; i >= 0; i--) {
                    const obj = objects[i];
                    
                    obj.y += obj.speed * GRAVITY_FACTOR;
                    obj.element.style.top = obj.y + 'px';

                    const isCollision = checkCollision(obj);

                    if (isCollision) {
                        handleCollision(obj, i);
                        continue;
                    }

                    if (obj.y > container.clientHeight - OBJECT_SIZE) {
                        if (obj.element.dataset.type === 'gift') {
                            missed++;
                            missedDisplay.textContent = missed;
                        }
                        removeObject(i);
                    }
                }
                
                if (missed >= 10) {
                    stopGame(`Gioco Finito! Punteggio finale: ${score}. Raggiunto livello ${currentLevel}.`);
                }
            }

            function checkCollision(obj) {
                const objBottom = obj.y + OBJECT_SIZE;
                const objLeft = parseFloat(obj.element.style.left);

                const sleighTop = container.clientHeight - sleigh.clientHeight - COLLISION_BUFFER_Y; 
                const sleighLeft = sleighX;
                const sleighRight = sleighX + SLEIGH_WIDTH;

                return objBottom >= sleighTop && 
                       objLeft < sleighRight && 
                       (objLeft + OBJECT_SIZE) > sleighLeft;
            }

            function handleCollision(obj, index) {
                if (obj.element.dataset.type === 'gift') {
                    score += 10;
                    scoreDisplay.textContent = score;
                    obj.element.textContent = '‚úÖ'; 
                } else if (obj.element.dataset.type === 'coal') {
                    score = Math.max(0, score - 5); 
                    scoreDisplay.textContent = score;
                    obj.element.textContent = 'üî•'; 
                }
                
                removeObject(index); 
            }

            function removeObject(index) {
                // üö© Controllo di sicurezza: verifica che l'elemento sia effettivamente un figlio prima di rimuoverlo
                if (index >= 0 && index < objects.length && container.contains(objects[index].element)) {
                    container.removeChild(objects[index].element);
                    objects.splice(index, 1);
                }
            }

            // =========================================================
            // CONTROLLO INPUT E GIOCO
            // =========================================================
            
            sleigh.addEventListener('mousedown', (e) => {
                if (!running) return;
                e.preventDefault(); 
                
                let shiftX = e.clientX - sleigh.getBoundingClientRect().left;
                let containerLeft = container.getBoundingClientRect().left;

                function onMouseMove(event) {
                    let newX = event.clientX - shiftX - containerLeft;
                    updateSleighPosition(newX);
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            document.addEventListener('keydown', (e) => {
                if (!running) return;
                if (e.key === 'ArrowLeft') {
                    updateSleighPosition(sleighX - SLEIGH_SPEED);
                } else if (e.key === 'ArrowRight') {
                    updateSleighPosition(sleighX + SLEIGH_SPEED);
                }
            });

            restartButton.addEventListener('click', startGame);

            function startGame() {
                // Pulizia aggressiva di tutti gli intervalli
                clearInterval(gameLoopInterval);
                clearInterval(spawnInterval);

                // Pulizia aggressiva del DOM e dell'array
                objects.forEach(obj => {
                    if (container.contains(obj.element)) {
                        container.removeChild(obj.element);
                    }
                });
                objects = []; // üö© Azzeramento completo dell'array

                // Reset ai valori iniziali
                currentLevel = 1;
                GRAVITY_FACTOR = INITIAL_GRAVITY; 
                SPAWN_INTERVAL_MS = 1000;

                score = 0;
                missed = 0;
                scoreDisplay.textContent = score;
                missedDisplay.textContent = missed;
                levelDisplay.textContent = currentLevel;
                initSleighPosition();

                running = true;

                gameLoopInterval = setInterval(updateGame, 1000 / 60); 
                spawnInterval = setInterval(createFallingObject, SPAWN_INTERVAL_MS);
            }

            function stopGame(message) {
                running = false;
                clearInterval(gameLoopInterval);
                clearInterval(spawnInterval);
                alert(message);
            }

            startGame();

        }); 

    </script>

</body>
</html>
